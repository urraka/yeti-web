<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
	<title>yeti</title>
	<script type="text/javascript" src="font.js"></script>
	<style type="text/css">
		html,body { margin: 0; padding: 0; width: 100%; height: 100%; }
		body { background: #CCC; }

		#images { position: absolute; top: 0; left: 0; width: 1px; height: 1px; opacity: 0; }
		#images img { position: absolute; bottom: 0; }

		canvas {
			display: block;
			width: 70vh;
			height: 100%;
			max-width: 100%;
			margin: auto;
			position: absolute;
			top:0;
			bottom:0;
			left:0;
			right:0;
			-webkit-user-select: none;
			-moz-user-select: none;
			user-select: none;
		}

		#view {
			z-index: 4;
			width: 70vh;
			max-width: 100%;
			height: 100%;
			margin: auto;
			position: absolute;
			top: 0;
			bottom: 0;
			left:0;
			right:0;
		}

		.scores {
			display: none;
			background: #FFF;
			border: 0.2cm solid black;
			margin: 0.5cm;
			padding: 0.5cm;
			font-weight: bold;
			font-size: 0.25cm;
			font-family: Verdana;
			color: #FFF;
			line-height: 1.5em;
			text-shadow:
				-1px -1px 1px #000, 1px -1px 1px #000,
				-1px 1px 1px #000, 1px 1px 1px #000,
				-1px -1px 1px #000, 1px -1px 1px #000,
				-1px 1px 1px #000, 1px 1px 1px #000,
				-1px -1px 1px #000, 1px -1px 1px #000,
				-1px 1px 1px #000, 1px 1px 1px #000,
				-1px -1px 1px #000, 1px -1px 1px #000,
				-1px 1px 1px #000, 1px 1px 1px #000;
		}

		.scores.visible { display: block; }

		.scores-current, .scores-best {
			display: inline-block;
			width: 50%;
			vertical-align: top;
		}

		.scores-points {
			font-size: 400%;
			color: #FF0;
			margin-top: 0.5cm;
			margin-bottom: 1cm;
			text-align: center;
		}

		.scores-header {
			font-size: 120%;
			color: #FF0;
			margin-bottom: 0.4cm;
		}

		.top-bar {
			z-index: 5;
			width: 70vh;
			max-width: 100%;
			height: 1.2cm;
			margin: auto;
			position: absolute;
			bottom: 0;
			left:0;
			right:0;
		}

		.config-open {
			display: block;
			margin: 0.2cm;
			width: 1cm;
			height: 1cm;
			background-image: url('settings.png');
			background-size: 1cm 1cm;
			opacity: 0.3;
			text-decoration: none;
			-webkit-tap-highlight-color: rgba(0,0,0,0);
			cursor: pointer;
		}

		.config {
			display: none;
			z-index: 10;
			width: 70vh;
			max-width: 100%;
			height: 100%;
			margin: auto;
			position: absolute;
			top: 0;
			bottom: 0;
			left:0;
			right:0;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}

		.config.visible {
			display: block;
		}

		.config-header {
			background: white;
			height: 1.5cm;
			line-height: 1.5cm;
			padding-left: 0.2cm;
			font-size: 0.8cm;
			font-family: Verdana;
			border-bottom: 1px solid #CCC;
			box-sizing: border-box;
		}

		.config-header a {
			text-decoration: none;
			color: #000;
			-webkit-tap-highlight-color: rgba(0,0,0,0);
		}

		.config-entries {
			background: white;
			position: absolute;
			top: 1.5cm;
			bottom: 0;
			left: 0;
			right: 0;
			overflow-y: auto;
			-webkit-overflow-scrolling: touch;
		}

		.config-entries:before {
			content: "";
			position: absolute;
			top: -1.5cm;
			bottom: -1px;
			width: 1px;
		}

		.config-entry {
			border-bottom: 1px solid #CCC;
		}

		.config input {
			font-family: Arial;
			display: block;
			font-size: 0.5cm;
			border: 0;
			width: 100%;
			padding: 0.2cm;
			margin: 0;
			text-align: left;
			box-sizing: border-box;
			outline: none;
		}

		.config label {
			font-family: Arial;
			font-size: 0.5cm;
			border: 0;
			margin: 0;
			padding: 0.2cm;
			width: 100%;
			overflow: hidden;
			text-overflow: ellipsis;
			white-space: nowrap;
			box-sizing: border-box;
		}
	</style>
</head>
<body onload="main()">

<div id="images">
<img src="yeti-0.png"           center="14,40" />
<img src="yeti-1.png"           center="14,40" />
<img src="yeti-crash2.png"      center="13,38" />
<img src="yeti-break.png"       center="15,40" />
<img src="yeti-break-left.png"  center="15,40" />
<img src="yeti-break-right.png" center="15,40" />
<img src="yeti-berried.png"     center="16,39" />
<img src="eating-5.png"         center="13,38" />
<img src="eating-6.png"         center="13,38" />
<img src="eating-left-1.png"    center="13,38" />
<img src="eating-left-2.png"    center="13,38" />
<img src="eating-left-3.png"    center="13,38" />
<img src="eating-left-4.png"    center="13,38" />
<img src="eating-left-5.png"    center="13,38" />
<img src="eating-left-6.png"    center="13,38" />
<img src="eating-right-1.png"   center="13,38" />
<img src="eating-right-2.png"   center="13,38" />
<img src="eating-right-3.png"   center="13,38" />
<img src="eating-right-4.png"   center="13,38" />
<img src="eating-right-5.png"   center="13,38" />
<img src="eating-right-6.png"   center="13,38" />
<img src="tree.png"             center="16,63" />
<img src="skiman.png"           center="11,24" />
<img src="skiman-dead.png"      center="11,24" />
<img src="flag-left.png"        center="6,24" />
<img src="flag-right.png"       center="6,24" />
<img src="flag-points-green.png"center="0,0" />
<img src="rock.png"             center="11,11" />
<img src="font.png"             center="0,0" />
<img src="speedometer.png"      center="98,91" />
<img src="needle.png"           center="12,11" />
<img src="shadow.png"           center="11,5" />
<img src="axe.png"              center="11,12" />
</div>

<canvas id="canvas"></canvas>
<div id="view">
	<div class="scores">
		<div class="scores-points"></div>
		<div class="scores-current">
			<div class="scores-header">CURRENT</div>
			<div class="scores-text"></div>
		</div><div class="scores-best">
			<div class="scores-header">BEST</div>
			<div class="scores-text"></div>
	</div></div>
</div>
<div class="top-bar">
	<a class="config-open"></a>
</div>
<div class="config">
	<div class="config-header"><a class="config-close" href="#">X</a></div>
	<div class="config-entries"></div>
</div>

<script>

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

var cfg_func = {
	noop: function(x) { return x; },
	to_string: function(x) { return x.toString(); },
	to_int: function(x) { return parseInt(x); },
	to_float: function(x) { return parseFloat(x); },
	to_bool: function(x) { return x === "1" || x === "true" || x === "yes"; }
};

var cfg = {
	"zigzag_bonus": {
		def: 10,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"zigzag_time": {
		def: 0.5,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"zigzag_threshold": {
		def: 3,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"air_xmult": {
		def: 0.15,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"jump_vel": {
		def: 320,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"G": {
		def: -900,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"slope": {
		def: 30,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"godmode": {
		def: false,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_bool
	},
	"hide_ui": {
		def: false,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_bool
	},
	"start_speedup": {
		def: 1.5,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"timer_show_duration": {
		def: 3,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"timer_flags": {
		def: 10,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_int
	},
	"vel_angle_min": {
		def: 225,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"vel_angle_max": {
		def: -45,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"break_mult": {
		def: 0.4,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"min_xmult": {
		def: 0.2,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"base_speed": {
		def: 300,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"min_speed": {
		def: 150,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"max_speed": {
		def: 800,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"speed_boost": {
		def: 75,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"boost_duration": {
		def: 3,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"accel": {
		def: 250,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"deaccel": {
		def: 100,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_float
	},
	"checkpoint_mode": {
		def: "rocks",
		to_str: cfg_func.noop,
		from_str: cfg_func.noop
	},
	"view_width": {
		def: 240,
		to_str: cfg_func.to_string,
		from_str: cfg_func.to_int
	},
	"flash_color": {
		def: {r:1,g:1,b:0},
		to_str: function(v) { return [v.r,v.g,v.b].join(","); },
		from_str: function(s) {
			var c = s.split(",");
			return {r:parseFloat(c[0]), g:parseFloat(c[1]), b:parseFloat(c[2])};
		}
	}
};

function cfg_value(param)
{
	return cfg[param].value;
}

function cfg_is_default()
{
	for (var i in cfg)
	{
		if (cfg[i].value !== cfg[i].def)
			return false;
	}

	return true;
}

function cfg_init()
{
	var config = document.querySelector(".config");
	var config_entries = document.querySelector(".config-entries");

	for (var i in cfg)
	{
		var value = url_query_value(i, "");

		if (value === "")
			cfg[i].value = cfg[i].def;
		else
			cfg[i].value = cfg[i].from_str(value);

		var entry = document.createElement("div");
		var label = document.createElement("label");
		var input = document.createElement("input");

		entry.classList.add("config-entry");
		label.setAttribute("for", "cfg_" + i);
		label.textContent = i;
		input.setAttribute("id", "cfg_" + i);
		input.setAttribute("type", "text");
		input.setAttribute("value", cfg[i].to_str(cfg[i].value));

		entry.appendChild(label);
		entry.appendChild(input);
		config_entries.appendChild(entry);
	}
}

function main()
{
	cfg_init();
	on_resize();

	var images = document.getElementsByTagName("img");

	for (var i = 0; i < images.length; i++)
	{
		var id = images[i].attributes["src"].value.split(".")[0];
		var center = images[i].attributes["center"].value.split(",");

		images[i].cx = parseInt(center[0]);
		images[i].cy = parseInt(center[1]);

		res(id, images[i]);
	}

	font_data.image = res("font");
	res("font", font_data);

	var game = Game();
	var t0 = time();
	var frame_id = null;

	game.restart();

	function frame()
	{
		var t1 = time();
		var dt = t1 - t0;

		if (dt < 0.25)
			game.update(dt);

		t0 = t1;
		frame_id = requestAnimationFrame(frame);
	}

	function on_resize(event)
	{
		var canvas = document.getElementById("canvas");

		canvas.width = 980;
		canvas.height = 980 * (canvas.offsetHeight / canvas.offsetWidth);

		var ctx = canvas.getContext("2d");

		ctx.mozImageSmoothingEnabled = false;
		ctx.webkitImageSmoothingEnabled = false;
		ctx.msImageSmoothingEnabled = false;
		ctx.imageSmoothingEnabled = false;
	}

	function on_event(event) { game.event(event); }

	function set_game_events()
	{
		window.addEventListener("resize", on_resize);
		window.addEventListener("devicemotion", on_event);
		window.addEventListener("mousedown", on_event);
		window.addEventListener("mouseup", on_event);
		window.addEventListener("mousemove", on_event);
		window.addEventListener("touchend", on_event);
		window.addEventListener("touchstart", on_event);
		window.addEventListener("keydown", on_event);
	}

	function unset_game_events()
	{
		window.removeEventListener("resize", on_resize);
		window.removeEventListener("devicemotion", on_event);
		window.removeEventListener("mousedown", on_event);
		window.removeEventListener("mouseup", on_event);
		window.removeEventListener("mousemove", on_event);
		window.removeEventListener("touchend", on_event);
		window.removeEventListener("touchstart", on_event);
		window.removeEventListener("keydown", on_event);
	}

	set_game_events();
	frame_id = requestAnimationFrame(frame);

	// config view events

	var config = document.querySelector(".config");
	var config_entries = document.querySelector(".config-entries");
	var config_close = document.querySelector(".config-close");
	var config_open = document.querySelector(".config-open");

	function on_config_open(e)
	{
		unset_game_events();
		cancelAnimationFrame(frame_id);
		config.classList.add("visible");
		e.stopPropagation();
		e.preventDefault();
	}

	function on_config_close(e)
	{
		for (var i in cfg)
		{
			var input = document.getElementById("cfg_" + i);
			cfg[i].value = cfg[i].from_str(input.value);
		}

		config.classList.remove("visible");
		e.stopPropagation();
		e.preventDefault();

		t0 = time();
		game.restart();
		set_game_events();
		frame_id = requestAnimationFrame(frame);
	}

	window.addEventListener("touchstart", function(e) { e.preventDefault(); });
	config_entries.addEventListener("touchstart", function(e) { e.stopPropagation(); });
	config_close.addEventListener("touchstart", on_config_close);
	config_close.addEventListener("mousedown", on_config_close);
	config_open.addEventListener("touchstart", on_config_open);
	config_open.addEventListener("mousedown", on_config_open);
}

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

function Game()
{
	var canvas = document.getElementById("canvas");
	var context = canvas.getContext("2d");
	var scene = Scene(canvas);

	function scale() { return canvas.width / cfg_value("view_width"); }
	function width() { return canvas.width / scale(); }
	function height() { return canvas.height / scale(); }

	function num_checkpoints(y)
	{
		return Math.max(0, Math.floor(Math.floor(y / grid_size) / flagdist));
	}

	var save_game_version = 1;

	function save_game()
	{
		if (!cfg_is_default())
			return;

		var data = {
			"version": save_game_version,
			"best_score": best_score,
			"best_checkpoint": best_checkpoint,
			"best_speed": best_speed,
			"best_times": []
		};

		for (var i = 0; i < best_times.length; i++)
			data.best_times.push(best_times[i]);

		localStorage.setItem("yeti", JSON.stringify(data));
	}

	function load_game()
	{
		var data = localStorage.getItem("yeti");

		if (data)
		{
			data = JSON.parse(data);

			if (save_game_version !== data.version)
			{
				localStorage.removeItem("yeti");
			}
			else
			{
				best_score = data.best_score;
				best_checkpoint = data.best_checkpoint;
				best_speed = data.best_speed || 0;
				best_times = [];

				for (var i = 0; i < data.best_times.length; i++)
					best_times.push(data.best_times[i]);
			}
		}
	}

	var score_board = {
		show: function() {
			this.board.classList.add("visible");
		},
		hide: function() {
			this.board.classList.remove("visible");
		},
		update: function() {
			this.update_table(this.current, {
				"points": points,
				"checkpoint": num_checkpoints(yeti.y),
				"speed": current_best_speed,
				"times": current_times
			});

			this.update_table(this.best, {
				"points": best_score,
				"checkpoint": best_checkpoint,
				"speed": best_speed,
				"times": best_times
			});

			this.points.textContent = points;
		},
		update_table: function(element, data) {
			while (element.firstChild)
				element.removeChild(element.firstChild);

			function item(text) {
				var e = document.createElement("div");
				e.textContent = text;
				return e;
			}

			element.appendChild(item("Points: " + data.points));
			element.appendChild(item("Checkpoints: " + data.checkpoint));
			element.appendChild(item("Max speed: " + data.speed.toFixed(1)));

			var N = cfg_value("timer_flags");

			for (var i = N - 1; i < data.times.length; i += N)
				element.appendChild(item("#" + (i + 1) + ": " + data.times[i].toFixed(2)));
		},
		board: document.querySelector(".scores"),
		current: document.querySelector(".scores-current .scores-text"),
		best: document.querySelector(".scores-best .scores-text"),
		points: document.querySelector(".scores-points")
	};

	var started = false;
	var objects = null;
	var yeti = null;
	var grid_size = null;
	var initial_spawn_cell = null;
	var spawn_index = null;
	var flagdist = null;
	var yeti_offset = null;
	var points = null;
	var points_flash_timer = null;
	var points_flash_duration = null;
	var flash_color = null;
	var flash_color_end = null;
	var flash_color_start = null;
	var checkpoint_mode = null;

	var best_score = 0;
	var best_checkpoint = 0;
	var best_average_speed = 0;
	var best_times = [];
	var current_times = [];
	var best_speed = 0;
	var current_best_speed = 0;

	var time_diff = 0;
	var elapsed_time = 0;
	var timer_value = 0;
	var timer_show_time = 0;
	var start_countdown = 0;
	var points_mult = 1;
	var point_marks = [];
	var point_marks_num = 0;

	for (var i = 0; i < 20; i++)
	{
		point_marks.push({
			index: i,
			text: "",
			life: 0,
			x: 0,
			align: "left"
		});
	}

	var objects_pool = {
		head: null,
		init: function(size) {
			this.head = new Sprite();
			var prev = this.head;

			for (var i = 0; i < size - 1; i++)
			{
				prev._next = new Sprite();
				prev = prev._next;
			}
		},
		alloc: function() {
			if (this.head !== null)
			{
				var ret = this.head;
				this.head = ret._next;
				Sprite.call(ret);
				return ret;
			}

			return null;
		},
		free: function(obj) {
			obj._next = this.head;
			this.head = obj;
		}
	};

	objects_pool.init(1000);

	load_game();

	return {
		restart: function()
		{
			score_board.hide();

			if (objects !== null)
				this.free_objects(0, objects.length);

			started = false;
			objects = [];
			yeti = Yeti();

			grid_size = 80;
			initial_spawn_cell = Math.ceil(height() / grid_size);
			spawn_index = initial_spawn_cell;
			flagdist = 6;
			yeti_offset = 100;

			points = 0;
			points_flash_timer = 0;
			points_flash_duration = 1.5;
			flash_color = {r: 1, g: 1, b: 1};
			flash_color_end = {r: 1, g: 1, b: 1};
			flash_color_start = cfg_value("flash_color");
			checkpoint_mode = cfg_value("checkpoint_mode");
			current_times = [];
			current_best_speed = 0;

			elapsed_time = 0;
			timer_show_time = 0;

			start_countdown = 3;
			points_mult = 1;
			point_marks_num = 0;
		},

		update: function(dt)
		{
			if (start_countdown > -1)
			{
				var delta = dt * cfg_value("start_speedup");

				if (Math.floor(start_countdown) + Math.floor(start_countdown - delta) === -1)
				{
					yeti.on_start();
					started = true;
				}

				start_countdown -= delta;
			}

			var w = width();
			var h = height();
			var prev_y = yeti.y;
			var was_dead = (yeti.state === "dead");

			yeti.update(dt, w, h);

			this.remove_objects();
			this.spawn_objects(w, h);
			this.check_collisions();
			this.update_point_marks(dt);
			this.update_objects(dt);

			var n = Math.round((yeti.speed() - cfg_value("base_speed")) / 35);

			if (n < 0)
				points_mult = 1 / (-n + 1);
			else
				points_mult = n + 1;

			var a = num_checkpoints(prev_y);
			var b = num_checkpoints(yeti.y);
			var p = Math.floor(100 * points_mult * (b - a));

			points += p;

			if (!cfg_value("godmode"))
			{
				best_score = Math.max(points, best_score);
				best_checkpoint = Math.max(b, best_checkpoint);
				best_speed = Math.max(yeti.speed(), best_speed);
			}

			current_best_speed = Math.max(yeti.speed(), current_best_speed);

			if (b - a > 0) // crossed a checkpoint
			{
				points_flash_timer = points_flash_duration;

				var timer_flags = cfg_value("timer_flags");

				var index = b - 1;
				var prev_best = best_times[index] || elapsed_time;
				var better_time = Math.min(prev_best, elapsed_time);

				current_times[index] = elapsed_time;

				if (!cfg_value("godmode"))
					best_times[index] = Math.min(prev_best, elapsed_time);

				if (b % timer_flags === 0)
				{
					time_diff = prev_best - elapsed_time;
					timer_show_time = cfg_value("timer_show_duration");
					timer_value = elapsed_time;
				}
			}

			if (p > 0 && point_marks_num < point_marks.length)
			{
				var mark = point_marks[point_marks_num++];

				mark.life = 1;
				mark.text = "+" + p;
				mark.align = yeti.x > 0 ? "right" : "left";

				mark.x = (240/2) + (240/2) * (yeti.x / (w / 2));
				mark.x += yeti.x > 0 ? -35 : 35;
			}

			if (yeti.z > 0)
				scene.add(yeti.shadow);

			scene.add(yeti);
			scene.add(objects);
			scene.draw(0, yeti.y - yeti_offset, scale());

			if (!cfg_value("hide_ui"))
				this.draw_ui(dt);

			if (started)
				elapsed_time += dt;

			if (!was_dead && yeti.state === "dead")
			{
				var average_speed = yeti.y / elapsed_time;
				best_average_speed = Math.max(average_speed, best_average_speed);

				save_game();

				score_board.update();
				score_board.show();
			}
		},

		update_objects: function(dt)
		{
			for (var i = 0, L = objects.length; i < L; i++)
			{
				if (objects[i].update)
					objects[i].update.call(objects[i], dt);
			}
		},

		check_collisions: function()
		{
			for (var i = 0, L = objects.length; i < L; i++)
			{
				if (!objects[i].image)
					continue;

				if (dist2(yeti.x, yeti.y, objects[i].x, objects[i].y) < 100)
				{
					yeti.collision(objects[i]);
					break;
				}
			}
		},

		free_objects: function(begin, end)
		{
			for (var i = begin; i < end; i++)
				objects_pool.free(objects[i]);
		},

		update_point_marks: function(dt)
		{
			for (var i = 0; i < point_marks_num; i++)
			{
				var mark = point_marks[i];

				mark.life -= dt;

				if (mark.life <= 0)
				{
					point_marks[i] = point_marks[point_marks_num - 1];
					point_marks[point_marks_num - 1] = mark;
					point_marks_num--;
					i--;
				}
			}
		},

		remove_objects: function()
		{
			for (var i = 0, L = objects.length; i < L; i++)
			{
				if (objects[i].y >= (yeti.y - yeti_offset - 50))
				{
					if (i > 0)
					{
						this.free_objects(0, i);
						objects = objects.slice(i);
					}

					break;
				}
			}
		},

		spawn_objects: function(w, h)
		{
			var max_index = Math.ceil((h + yeti.y) / grid_size);

			while (spawn_index <= max_index)
			{
				var y = spawn_index * grid_size;

				for (var x = grid_size/2; x < w; x += grid_size)
				{
					var rnd = noise(x, y);

					if (Math.abs(rnd) < 0.02)
					{
						var axe = objects_pool.alloc();
						axe.type = "axe";
						axe.image = res("axe");
						axe.x = Math.floor(x + 20 * rnd * 5 - w/2);
						axe.y = Math.floor(y + 20 * rnd * 5);
						objects.push(axe);
					}
					else if (Math.abs(rnd) < 0.04)
					{
						var skiman = objects_pool.alloc();
						skiman.type = "skiman";
						skiman.image = res("skiman");
						skiman.x = Math.floor(x + 20 * rnd * 5 - w/2);
						skiman.y = Math.floor(y + 20 * rnd * 5);
						objects.push(skiman);
					}
					else if (Math.abs(rnd) < 0.5)
					{
						var tree = objects_pool.alloc();
						tree.type = "tree";
						tree.image = res("tree");
						tree.x = Math.floor(x + 20 * rnd * 5 - w/2);
						tree.y = Math.floor(y + 20 * rnd * 5);
						objects.push(tree);
					}
				}

				if (spawn_index % flagdist === 0)
				{
					var hw = w/2;

					for (var x = -hw + 20; x < hw; x += w - 40)
					{
						var flag = objects_pool.alloc();
						flag.type = "flag";
						flag.image = res(x > 0 ? "flag-right" : "flag-left");
						flag.x = x;
						flag.y = y;
						objects.push(flag);
					}

					switch (checkpoint_mode)
					{
						case "skiman":
						{
							for (var x = -hw + 40; x < hw - 25; x += 20)
							{
								var skiman = objects_pool.alloc();
								skiman.type = "dumbskiman";
								skiman.image = res("skiman");
								skiman.x = x;
								skiman.y = y;
								objects.push(skiman);
							}
						}
						break;

						case "rocks":
						{
							var gap_width = 80;
							var gap_start = noise(1, y) * (hw - 20 - gap_width/2) - gap_width/2;

							for (var x = -hw + 40; x < hw - 25; x += 20)
							{
								if (x >= gap_start && x <= gap_start + gap_width)
									continue;

								var rock = objects_pool.alloc();
								rock.type = "rock";
								rock.image = res("rock");
								rock.x = x;
								rock.y = y;
								objects.push(rock);
							}
						}
						break;

						case "rocks_and_skiman":
						{
							var gap_width = 80;
							var gap_start = noise(1, y) * (hw - 20 - gap_width/2) - gap_width/2;

							for (var x = -hw + 40; x < hw - 25; x += 20)
							{
								if (x >= gap_start && x <= gap_start + gap_width)
								{
									var skiman = objects_pool.alloc();
									skiman.type = "dumbskiman";
									skiman.image = res("skiman");
									skiman.x = x;
									skiman.y = y;
									objects.push(skiman);
								}
								else
								{
									var rock = objects_pool.alloc();
									rock.type = "rock";
									rock.image = res("rock");
									rock.x = x;
									rock.y = y;
									objects.push(rock);
								}
							}
						}
						break;
					}
				}

				spawn_index++;
			}
		},

		draw_ui: function(dt)
		{
			var s = 980 / 240;
			var w = canvas.width / s;
			var h = canvas.height / s;

			context.save();
			context.scale(s, s);

			// point marks

			var x = w/2 + (w/2) * (yeti.x / (cfg_value("view_width") / 2));
			var y = yeti_offset * scale() / s;
			var sz = 80;

			context.save();
			context.translate(0, y);

			for (var i = 0; i < point_marks_num; i++)
			{
				var mark = point_marks[i];
				var p = Easing.in_quad(1 - mark.life, 0, 1, 1);

				context.globalAlpha = 1 - p;
				context.translate(mark.x, -20 - 100 * p);
				context.scale(0.3, 0.3);

				draw_string(context, res("font"), mark.text, 0, 0, mark.align);

				context.scale(1 / 0.3, 1 / 0.3);
				context.translate(-mark.x, -(-20 - 100 * p));
			}

			context.restore();

			// checkpoints

			if (started)
			{
				var flag = res("flag-points-green");
				var n = num_checkpoints(yeti.y).toString();

				context.save();
				context.translate(5, 48/2);
				context.scale(0.5, 0.5);
				var text_width = draw_string(context, res("font"), n, 0, 3, "left");
				var sc = 0.43;
				context.restore();

				context.drawImage(flag, 0, 0, flag.width, flag.height, 10 + text_width * 0.5, 6.5,
					sc * flag.width, sc * flag.height);
			}

			// points

			if (started)
			{
				context.save();
				context.translate(w - 5, 48/2);
				context.scale(0.5, 0.5);
				draw_string(context, res("font"), points.toString(), 0, 3, "right");

				if (points_mult !== 1)
				{
					var m = "x" + Math.round(100 * points_mult) / 100;
					draw_string(context, res("font"), m, 0, 3 + 48, "right");
				}

				context.restore();
			}

			// axe

			if (yeti.num_axes() > 0)
			{
				context.drawImage(res("axe"), 5, 48/2 + 7);
				context.save();
				context.translate(5 + 20, 48/2 + 24 + 7);
				context.scale(0.25, 0.25);
				draw_string(context, res("font"), "x" + yeti.num_axes(), 0, 0, "left");
				context.restore();
			}

			if (started && yeti.state !== "dead")
			{
				// timers

				if (timer_show_time > 0)
				{
					var t = Math.abs(timer_value);
					var min = Math.floor(t / 60);
					var sec = (t - min * 60).toFixed(1);
					var str = min + ":" + sec;
					var padding = 5;

					context.save();
					context.translate(w/2, h - padding);
					context.scale(0.4, 0.4);

					draw_string(context, res("font"), str, 0, 0, "center");

					if (Math.floor(points / cfg_value("timer_flags")) > 0)
					{
						t = Math.round(time_diff * 100) / 100;
						str = (t >= 0 ? "+" : "-") + Math.abs(t).toFixed(2);

						context.translate(0, -res("font").size);
						draw_string(context, res("font"), str, 0, 0, "center");
					}

					context.restore();

					timer_show_time -= dt;
				}

				// velocity

				var vel0 = cfg_value("min_speed");
				var vel1 = cfg_value("max_speed");
				var a0 = -to_radians(cfg_value("vel_angle_min"));
				var a1 = -to_radians(cfg_value("vel_angle_max"));
				var angle = lerp(a0, a1, (yeti.speed() - vel0) / (vel1 - vel0));
				var r = 14;
				var x = w / 2;
				var y = r + 5;

				var speedometer = res("speedometer");
				var needle = res("needle");

				context.save();
				context.translate(x, y);
				context.scale(0.15, 0.15);
				context.drawImage(speedometer, -speedometer.cx, -speedometer.cy);
				context.rotate(angle);
				context.drawImage(needle, -needle.cx, -needle.cy);
				context.restore();
			}

			if (start_countdown > -1)
			{
				var str = Math.ceil(start_countdown).toString();

				if (str === 0)
					str = "GO!";

				context.translate(w/2, h/2);
				draw_string(context, res("font"), str, 0, 48/2, "center");
			}

			context.restore();
		},

		event: function(event)
		{
			switch (event.type)
			{
				case "devicemotion":
					yeti.on_motion(event);
					break;

				case "touchstart":
					event.preventDefault();
				case "mousedown":
				{
					if (yeti.state === "dead")
						this.restart();
					else if (event.pageY > canvas.offsetHeight / 2)
						yeti.on_break(true);
					else
						yeti.on_jump();

					event.preventDefault();
				}
				break;

				case "touchend":
				case "mouseup":
					yeti.on_break(false);
					break;

				case "mousemove":
				{
					var x = clamp(event.pageX - canvas.offsetLeft, 0, canvas.offsetWidth);
					yeti.on_mousemove({normX: x / canvas.offsetWidth});
				}
				break;

				case "keydown":
				{
					if (event.keyCode === 90)
						yeti.on_jump();
				}
				break;
			}
		}
	};
}

Game.flying_tree = function(dt)
{
	this.x += 20 * dt;
	// this.angle += 4 * Math.PI * dt;
}

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

function Yeti()
{
	var self = new Sprite();

	self.z = 0;
	self.state = "running";
	self.shadow = new Sprite();
	self.shadow.image = res("shadow");

	var base_speed = cfg_value("base_speed");
	var min_speed = cfg_value("min_speed");
	var speed_boost = cfg_value("speed_boost");
	var boost_duration = cfg_value("boost_duration");
	var accel = cfg_value("accel");
	var deaccel = cfg_value("deaccel");
	var min_xmult = cfg_value("min_xmult");
	var break_mult = cfg_value("break_mult");
	var real_max_speed = cfg_value("max_speed");

	var xdest = 0;
	var xnorm = 0;
	var zspeed = 0;
	var jump_yspeed = 0;
	var acceleration = accel;
	var speed = base_speed;
	var maxspeed = base_speed;
	var frame = 0;
	var eating = false;
	var breaking = false;
	var eatstart = 0;
	var boosttime = 0;
	var low_movement_time = 0;
	var num_axes = 0;

	var deadframe = res("yeti-crash2");
	var breakframe = res("yeti-break");
	var breaklframe = res("yeti-break-left");
	var breakrframe = res("yeti-break-right");
	var runframes = [res("yeti-0"), res("yeti-1")];
	var waitframes = [res("eating-5"), res("eating-6")];

	var eatframes = [
		[res("eating-left-1"), res("eating-right-1")],
		[res("eating-left-2"), res("eating-right-2")],
		[res("eating-left-3"), res("eating-right-3")],
		[res("eating-left-4"), res("eating-right-4")],
		[res("eating-left-5"), res("eating-right-5")],
		[res("eating-left-6"), res("eating-right-6")],
		[res("eating-left-5"), res("eating-right-5")],
		[res("eating-left-6"), res("eating-right-6")],
		[res("eating-left-5"), res("eating-right-5")],
		[res("eating-left-6"), res("eating-right-6")],
		[res("eating-left-5"), res("eating-right-5")],
		[res("eating-left-6"), res("eating-right-6")]
	];

	self.init = function()
	{
		self.state = "waiting";
		self.x = 0;
		self.y = 0;
		self.z = 0;
		xdest = 0;
		xnorm = 0;
		zspeed = 0;
		speed = base_speed;
		maxspeed = base_speed;
		frame = 0;
		eating = false;
		breaking = false;
		eatstart = 0;
		boosttime = 0;
		low_movement_time = 0;
		num_axes = 0;
	}

	self.init();

	self.speed = function() { return speed; }
	self.num_axes = function() { return num_axes; }

	self.on_jump = function()
	{
		if (self.z !== 0 || self.state !== "running")
			return;

		zspeed = cfg_value("jump_vel");
		jump_yspeed = speed;
	}

	self.on_start = function()
	{
		self.state = "running";
	}

	self.on_break = function(value)
	{
		breaking = value;

		if (self.state === "running")
			self.image = breakframe;
	}

	self.on_mousemove = function(event)
	{
		if (self.state !== "running")
			return;

		xdest = event.normX * 2 - 1;
	}

	self.on_motion = function(event)
	{
		if (self.state !== "running")
			return;

		var rot = event.rotationRate.beta;

		if (Math.abs(rot * 0.01) > 0.001)
			xdest = clamp(xnorm + rot * 0.01, -1, 1);
	}

	self.update = function(dt, w, h)
	{
		switch (self.state)
		{
			case "running":
			{
				if (boosttime > 0)
				{
					boosttime -= dt;

					if (boosttime <= 0)
					{
						var zt = Math.max(0, low_movement_time - cfg_value("zigzag_time"));
						var zb = cfg_value("zigzag_bonus");

						maxspeed = base_speed + zt * zb;
					}
				}

				var G = cfg_value("G");
				var slope_angle = to_radians(cfg_value("slope"));
				var prevz = self.z;

				zspeed += G * Math.cos(slope_angle) * dt;
				self.z += zspeed * dt;

				if (self.z <= 0)
				{
					self.z = 0;
					zspeed = 0;

					if (prevz !== 0)
						speed = jump_yspeed;
				}

				var mult = (speed - min_speed) / (base_speed - min_speed);
				var dxnorm = xdest - xnorm;

				if (self.z > 0)
				{
					xnorm += dxnorm * 0.15 * cfg_value("air_xmult");
				}
				else if (breaking)
				{
					var m = (speed - min_speed) / (real_max_speed - min_speed);
					xnorm += dxnorm * 0.15 * clamp(m, min_xmult, 1);
				}
				else
				{
					xnorm += dxnorm * 0.15 * clamp(mult, min_xmult, 1);
				}

				var hw = w / 2;
				var x = clamp(xnorm * hw, -(hw - 16), hw - 16);
				var dx = x - self.x;

				if (Math.abs(dx) > cfg_value("zigzag_threshold") || self.z > 0)
				{
					var zt = Math.max(0, low_movement_time - cfg_value("zigzag_time"));
					var zb = cfg_value("zigzag_bonus");

					low_movement_time = 0;
					maxspeed -= zt * zb; // TODO: this will be wrong when using breaks
				}

				if (self.z === 0)
				{
					low_movement_time += dt;

					if (low_movement_time > cfg_value("zigzag_time"))
						maxspeed += cfg_value("zigzag_bonus") * dt;

					if (speed > maxspeed || breaking)
					{
						var acc = deaccel;

						if (breaking)
							acc = clamp(mult, break_mult, 1) * acceleration + dx;

						speed = Math.max(breaking ? min_speed : maxspeed, speed - acc * dt);

						if (breaking && speed < maxspeed)
							maxspeed = Math.max(speed, base_speed);
					}
					else
						speed = Math.min(maxspeed, speed + acceleration * dt);
				}
				else if (zspeed <= 0)
				{
					speed += -G * Math.sin(slope_angle) * dt;
					low_movement_time = 0;
				}

				var dy = speed * dt;

				self.x = x;
				self.y += dy;

				if (speed === min_speed)
				{
					self.image = res("yeti-berried");
					self.state = "dead";
					return;
				}

				if (eating && !breaking)
				{
					frame = (frame + 10 * dt);
					var eatframe = frame - eatstart;

					if ((eatframe|0) < eatframes.length)
						self.image = eatframes[eatframe|0][(frame % 2)|0];
					else
						eating = false;
				}
				else if (breaking)
				{
					eating = false;

					var delta = dxnorm * hw;
					var alpha = 10;

					if (delta > alpha)
						self.image = breakrframe;
					else if (delta < -alpha)
						self.image = breaklframe;
					else if (Math.abs(delta) < 0.5)
						self.image = breakframe;
				}
				else
				{
					frame = (frame + 10 * dt) % 2;
					self.image = runframes[frame|0];
				}

				self.shadow.x = self.x;
				self.shadow.y = self.y;
			}
			break;

			case "waiting":
			{
				frame = (frame + 10 * dt) % 2;
				self.image = waitframes[frame|0];
			}
			break;
		}
	}

	self.collision = function(object)
	{
		if (cfg_value("godmode"))
			return;

		switch (object.type)
		{
			case "tree":
				if (num_axes > 0)
				{
					num_axes--;
					object.update = Game.flying_tree;
					object.type = "flying_tree";
					break;
				}

			case "rock":
			case "flag":
			{
				speed = 0;

				if (self.y >= object.y)
					self.y = object.y - 1;

				xdest = xnorm;
				self.state = "dead";

				if (object.type === "tree")
				{
					self.image = deadframe;
				}
				else
				{
					self.z = 0;
					self.image = res("yeti-berried");
				}
			}
			break;

			case "dumbskiman":
			{
				if (self.z === 0)
					object.image = res("skiman-dead");
			}
			break;

			case "skiman":
			{
				if (self.z === 0)
				{
					if (!breaking)
					{
						object.image = null;
						eatstart = frame;
						eating = true;
						maxspeed = Math.min(real_max_speed, speed + speed_boost);
						boosttime = boost_duration;
					}
					else
					{
						object.image = res("skiman-dead");
					}
				}
			}
			break;

			case "axe":
			{
				if (self.z === 0)
				{
					object.image = null;
					num_axes++;
				}
			}
			break;
		}
	}

	return self;
}

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

function Sprite()
{
	this.x = 0;
	this.y = 0;
	this.z = 0;
	this.angle = 0;
	this.image = null;
}

function Scene(canvas)
{
	var context = canvas.getContext("2d");
	var sprites = [];

	function cmp(a, b)
	{
		return a.y - b.y;
	}

	return {
		add: function(x)
		{
			if (x instanceof Array)
			{
				var N = x.length;

				for (var i = 0; i < N; i++)
					sprites.push(x[i]);
			}
			else
			{
				sprites.push(x);
			}
		},

		draw: function(x, y, scale)
		{
			var L = sprites.length;
			var w = canvas.width;
			var h = canvas.height;

			sprites.sort(cmp);

			context.save();
			context.fillStyle = "#FFF";
			context.fillRect(0, 0, w, h);
			context.translate(Math.floor(w/2 - x), 0);
			context.scale(scale, scale);
			context.translate(0, -y);

			for (var i = 0; i < L; i++)
			{
				var s = sprites[i];

				if (s.image)
				{
					context.rotate(s.angle);
					context.drawImage(s.image, s.x - s.image.cx, s.y - s.image.cy - s.z);
					context.rotate(-s.angle);
				}
			}

			context.restore();

			for (var i = 0; i < L; i++)
				sprites.pop();
		}
	};
}

function draw_string(context, font, str, x, y, align)
{
	var L = str.length;
	var W = 0;

	for (var i = 0; i < L; i++)
		W += font.glyphs[str[i]].advance;

	y = y - font.base;

	if (align === "right")
		x = x - W;
	else if (align == "center")
		x = x - W/2;

	for (var i = 0; i < L; i++)
	{
		var g = font.glyphs[str[i]];

		context.drawImage(
			font.image,
			g.x, g.y, g.w, g.h,
			x + g.xoff, y + g.yoff, g.w, g.h
		);

		x += g.advance;
	}

	return W;
}

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

function res(id, value)
{
	if (value)
	{
		res.items = res.items || {};
		res.items[id] = value;
	}
	else
	{
		return res.items[id];
	}
}

function time()
{
	return Date.now() / 1000;
}

function clamp(x, a, b)
{
	return Math.min(b, Math.max(a, x));
}

function sign(x)
{
	return x < 0 ? -1 : 1;
}

function noise(x, y)
{
	return (Math.sin(x * 12.9898 + y * 78.233) * 43758.5453) % 1;
}

function sqr(x)
{
	return x*x;
}

function dist2(ax, ay, bx, by)
{
	return sqr(bx - ax) + sqr(by - ay);
}

function lerp(a, b, p)
{
	return a + (b - a) * p;
}

function to_radians(value)
{
	return value * Math.PI / 180;
}

function url_query_value(name, def)
{
	if (!url_query_value.params)
	{
		var qs = location.search.split("+").join(" ");

		var params = {};
		var re = /[?&]?([^=]+)=([^&]*)/g;
		var tokens;

		while (tokens = re.exec(qs))
			params[decodeURIComponent(tokens[1])] = decodeURIComponent(tokens[2]);

		url_query_value.params = params;
	}

	if (name in url_query_value.params)
		return url_query_value.params[name];
	else
		return def;
}

//****************************************************************************//
//****************************************************************************//
//****************************************************************************//

Easing = {
	in_quad: function (t, b, c, d) {
		return c*(t/=d)*t + b;
	},
	out_quad: function (t, b, c, d) {
		return -c *(t/=d)*(t-2) + b;
	},
	in_out_quad: function (t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t + b;
		return -c/2 * ((--t)*(t-2) - 1) + b;
	},
	in_cubic: function (t, b, c, d) {
		return c*(t/=d)*t*t + b;
	},
	out_cubic: function (t, b, c, d) {
		return c*((t=t/d-1)*t*t + 1) + b;
	},
	in_out_cubic: function (t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t + b;
		return c/2*((t-=2)*t*t + 2) + b;
	},
	in_quart: function (t, b, c, d) {
		return c*(t/=d)*t*t*t + b;
	},
	out_quart: function (t, b, c, d) {
		return -c * ((t=t/d-1)*t*t*t - 1) + b;
	},
	in_out_quart: function (t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t + b;
		return -c/2 * ((t-=2)*t*t*t - 2) + b;
	},
	in_quint: function (t, b, c, d) {
		return c*(t/=d)*t*t*t*t + b;
	},
	out_quint: function (t, b, c, d) {
		return c*((t=t/d-1)*t*t*t*t + 1) + b;
	},
	in_out_quint: function (t, b, c, d) {
		if ((t/=d/2) < 1) return c/2*t*t*t*t*t + b;
		return c/2*((t-=2)*t*t*t*t + 2) + b;
	},
	in_sine: function (t, b, c, d) {
		return -c * Math.cos(t/d * (Math.PI/2)) + c + b;
	},
	out_sine: function (t, b, c, d) {
		return c * Math.sin(t/d * (Math.PI/2)) + b;
	},
	in_out_sine: function (t, b, c, d) {
		return -c/2 * (Math.cos(Math.PI*t/d) - 1) + b;
	},
	in_expo: function (t, b, c, d) {
		return (t==0) ? b : c * Math.pow(2, 10 * (t/d - 1)) + b;
	},
	out_expo: function (t, b, c, d) {
		return (t==d) ? b+c : c * (-Math.pow(2, -10 * t/d) + 1) + b;
	},
	in_out_expo: function (t, b, c, d) {
		if (t==0) return b;
		if (t==d) return b+c;
		if ((t/=d/2) < 1) return c/2 * Math.pow(2, 10 * (t - 1)) + b;
		return c/2 * (-Math.pow(2, -10 * --t) + 2) + b;
	},
	in_circ: function (t, b, c, d) {
		return -c * (Math.sqrt(1 - (t/=d)*t) - 1) + b;
	},
	out_circ: function (t, b, c, d) {
		return c * Math.sqrt(1 - (t=t/d-1)*t) + b;
	},
	in_out_circ: function (t, b, c, d) {
		if ((t/=d/2) < 1) return -c/2 * (Math.sqrt(1 - t*t) - 1) + b;
		return c/2 * (Math.sqrt(1 - (t-=2)*t) + 1) + b;
	},
	in_elastic: function (t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return -(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
	},
	out_elastic: function (t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d)==1) return b+c;  if (!p) p=d*.3;
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		return a*Math.pow(2,-10*t) * Math.sin( (t*d-s)*(2*Math.PI)/p ) + c + b;
	},
	in_out_elastic: function (t, b, c, d) {
		var s=1.70158;var p=0;var a=c;
		if (t==0) return b;  if ((t/=d/2)==2) return b+c;  if (!p) p=d*(.3*1.5);
		if (a < Math.abs(c)) { a=c; var s=p/4; }
		else var s = p/(2*Math.PI) * Math.asin (c/a);
		if (t < 1) return -.5*(a*Math.pow(2,10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )) + b;
		return a*Math.pow(2,-10*(t-=1)) * Math.sin( (t*d-s)*(2*Math.PI)/p )*.5 + c + b;
	},
	in_back: function (t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*(t/=d)*t*((s+1)*t - s) + b;
	},
	out_back: function (t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		return c*((t=t/d-1)*t*((s+1)*t + s) + 1) + b;
	},
	in_out_back: function (t, b, c, d, s) {
		if (s == undefined) s = 1.70158;
		if ((t/=d/2) < 1) return c/2*(t*t*(((s*=(1.525))+1)*t - s)) + b;
		return c/2*((t-=2)*t*(((s*=(1.525))+1)*t + s) + 2) + b;
	},
	in_bounce: function (t, b, c, d) {
		return c - Easing.out_bounce(d-t, 0, c, d) + b;
	},
	out_bounce: function (t, b, c, d) {
		if ((t/=d) < (1/2.75)) {
			return c*(7.5625*t*t) + b;
		} else if (t < (2/2.75)) {
			return c*(7.5625*(t-=(1.5/2.75))*t + .75) + b;
		} else if (t < (2.5/2.75)) {
			return c*(7.5625*(t-=(2.25/2.75))*t + .9375) + b;
		} else {
			return c*(7.5625*(t-=(2.625/2.75))*t + .984375) + b;
		}
	},
	in_out_bounce: function (x, t, b, c, d) {
		if (t < d/2) return Easing.in_bounce(t*2, 0, c, d) * .5 + b;
		return Easing.out_bounce(t*2-d, 0, c, d) * .5 + c*.5 + b;
	}
}

</script>
</body>
</html>
